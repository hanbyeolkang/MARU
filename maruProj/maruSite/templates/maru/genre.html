{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARU Book analysis</title>
    <link rel="stylesheet" type="text/css" href="{% static 'maru/css/common.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'maru/css/genre.css' %}">

    <!-- Chart.js & DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <!-- Plotly.js CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

</head>
<body>
    <div id="whole">
        {% include 'maru/header.html' %}
        <div class="content">


            <!-- 통계 자료 시작 -->
            <!-- 도넛 차트 -->
            <section class="statistics">
                <span style="color: rgb(112, 112, 112); font-size: 14px;">Kyobo Bookstore Data Across 5 Regions</span>
                <div class="chart-wrapper">
                    <canvas id="genreChart"></canvas>
                </div>
            </section>

            <!-- 막대그래프 섹션 -->
            <section class="statistics">
                <span style="color: rgb(112, 112, 112); font-size: 14px;">Top Products by Genre</span>
                <div class="chart-wrapper">
                    <canvas id="genreGMVChart"></canvas>
                </div>
            </section>

            <!-- 장르별 Top3 섬네일 섹션 -->
            <section class="statistics">
                <span style="color: rgb(131, 131, 131); font-size: 14px;">Top 3 books by genre. Click to view on Koybo.</span>
                <p id="refresh-message" style="font-size:17px; color:rgb(112, 112, 112); font-weight:bold; margin-top:5px; text-align:center;">
                    장르별 책 둘러보기
                </p>
                <div id="genre-thumbnails" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            </section>

            <!-- 장르별 가격 표 섹션 -->
            <section class="statistics">
                <span style="color: rgb(112, 112, 112); font-size: 14px;">Book Prices by Genre (KRW)</span>
                <div class="chart-wrapper">
                    <canvas id="genrePriceChart"></canvas>
                </div>
            </section>

            <!-- 장르별 추천 섹션 -->
            <section class="statistics recommend-section">
                <span style="color: rgb(31, 146, 77); font-size: 14px;">↓ Click to discover more picks!</span>
                <p id="refresh-message" style="font-size:17px; color:rgb(112, 112, 112); font-weight:bold; margin-top:5px; text-align:center;">
                    MARU의 추천책 pick!
                </p>
                    <div style="text-align:center; margin-top:8px;">
                    <button id="refresh-recommend-btn">Pick 3</button>
                </div>
                <div id="recommend-thumbnails" class="recommend-container"></div>
            </section>


            <!-- 장르별 상관관계 히트맵 섹션 style="width:100%; height:500px;"-->
            <section class="statistics">
                <span style="color: rgb(112, 112, 112); font-size: 14px;">Genre Correlation Heatmap (Price, Score, Reviews, GMV)</span>
                <div class="chart-wrapper">
                    <div id="genre-heatmap"></div>
                </div>
            </section>



            <!-- 통계자료 끝 -->

        </div>
    </div>


    <!-- Back to Top 버튼 -->
    {% include 'maru/topBtn.html' %}

    <!-- Chart.js 스크립트 -->
    <script>
    // --- 도넛 차트 ---
    fetch("{% url 'genre-data' %}")
    .then(res => res.json())
    .then(data => {
        //data.sort((a,b) => genreOrder.indexOf(a.genre) - genreOrder.indexOf(b.genre));
        data.sort((a,b) => b.count - a.count);
        
        console.log("genre-data:", data);

        const labels = data.map(d => d.genre);
        const counts = data.map(d => d.count);
        const total = counts.reduce((a,b)=>a+b,0);
        const percents = counts.map(c => ((c/total)*100).toFixed(1));


        new Chart(document.getElementById('genreChart'), {
            type: 'doughnut',
            data: {
                labels: labels.map((label, i) => `${label} (${percents[i]}%)`),
                datasets: [{
                    data: counts,
                    backgroundColor: [
                    '#EB99A1','#EABF91','#F0E38D','#8CD1A8','#8CC7F0',
                    '#C1A8F0','#EB8CCB','#8DD8CC','#F0C89A','#9CC3F0'
                    ],
                    // backgroundColor: [
                    // '#FF6384','#36A2EB','#FFCE56','#8BC34A','#9C27B0',
                    // '#FF9800','#009688','#795548','#607D8B','#E91E63'
                    // ]
                    borderColor: '#333333',   // 테두리 색
                    borderWidth: 1,           // 테두리 두께
                    spacing: 5,               // 조각 사이 여유
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                cutout: '35%',
                radius: '80%',   // 반지름 축소
                plugins: {
                    title: {
                        display: true,
                        text: '장르별 도서 현황',
                        font: { size: 17, weight: 'bold' },
                        padding: { top: 0, bottom: 20 }
                    },
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 30 }
                    },
                    tooltip: { enabled: true, 
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 14 },
                        padding: 8,
                        cornerRadius: 6
                    },
                    datalabels: {
                        color: '#000',
                        font: { weight: 'bold', size: 14 },
                        formatter: (value, ctx) => {
                            //const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                            //const percent = (value/total*100).toFixed(1);
                            //return `${percent}%`; 
                            return ``;
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    });


    //-----------------------
    // --- 막대그래프 ---
    // ----------------------
    fetch("{% url 'genre-gmv-data' %}")
    .then(res => res.json())
    .then(data => {
        data.sort((a,b) => b.gmv - a.gmv);
        console.log("genre-gmv-data sorted:", data);

        // --- extraData 생성 ---
        const extraData = {};
        data.forEach(d => {
            extraData[d.genre] = {
                price: d.price,
                num_of_review: d.num_of_review,
                score: d.score
            };
        });
        
        const labels = data.map(d => d.genre);
        const gmvs = data.map(d => d.gmv);

        new Chart(document.getElementById('genreGMVChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '장르별 GMV (price * num_of_review * score)',
                    data: gmvs,
                    backgroundColor: '#8CC7F0',
                    borderColor: '#333333',   // 테두리 색
                    borderWidth: 1            // 테두리 두께
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '장르별 핵심상품',
                        font: { size: 17, weight: 'bold' }
                    },
                    // tooltip: {
                    //     enabled: true,
                    //     callbacks: {
                    //         label: (ctx) => Math.round(ctx.raw).toLocaleString()
                    //     }
                    // }
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(ctx) {
                                const genre = ctx.label;                 // 현재 막대의 장르 이름
                                const gmvStr = Math.round(ctx.raw).toLocaleString();

                                const info = extraData[genre] || {};  // ← 추가: extraData에서 장르 정보 가져오기
                                const price = info.price !== undefined ? Math.round(info.price).toLocaleString() : '-'; // 소수점 없이
                                const reviews = info.num_of_review !== undefined ? info.num_of_review.toLocaleString() : '-'; // ← 리뷰 수 고침
                                const score = info.score !== undefined ? info.score.toFixed(1) : '-'; // 그대로
                                                    return [
                                    `GMV: ${gmvStr}`,
                                    `평균 가격: ${price}원`,
                                    `평균 리뷰 수: ${reviews}개`,
                                    `평균 평점: ${score}점`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (val) => val.toLocaleString(),
                            //stepSize: 10000,   // tick 간격 (데이터 크기에 맞춰 조정)
                            //maxTicksLimit: 20  // 최대 표시 tick 수 제한
                        },
                        grid: {
                            display: true
                        }
                    },
                    x: {
                        //ticks: {
                            //maxRotation: 45,  // 글자 최대 45도 회전
                            //minRotation: 0
                        //},
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    });

    
    // ----------------------
    //--- 썸네일 ----
    // ----------------------
    fetch("{% url 'genre-top3-json' %}") // 새로 만든 view에서 JSON 반환
    .then(res => res.json())
    .then(data => {
        console.log("==== 장르별 top3 JSON 확인 ====");
        console.log(data); // ← 여기 찍으면 전체 JSON 확인 가능

        const container = document.getElementById('genre-thumbnails');
        Object.keys(data).forEach(genre => {
            const books = data[genre]; // top3 책 배열

            const genreDiv = document.createElement('div');
            genreDiv.classList.add('genre-block');

            let html = `<h3 class="genre-title">${genre}</h3><div class="genre-books">`;
            books.forEach(book => {
                html += `
                    <div class="book-card">
                        <a href="${book.book_detail}" target="_blank" class="book-link">
                            <img src="${book.book_img}" class="book-img">
                            <p class="book-title">${book.title}</p>
                        </a>
                    </div>
                `;
            });
            html += `</div>`;

            genreDiv.innerHTML = html;
            container.appendChild(genreDiv);
        });
    });


    // --------------------------
    // --- 장르별 가격 통계 ---
    // --------------------------
    fetch("{% url 'genre-price-data' %}")
    .then(res => res.json())
    .then(data => {
        data.sort((a, b) => b.mean - a.mean);
        const labels = data.map(d => d.genre);
        const avgPrices = data.map(d => d.mean);
        const maxPrices = data.map(d => d.max);
        const minPrices = data.map(d => d.min);

        new Chart(document.getElementById('genrePriceChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '평균(Avg)',
                        data: avgPrices,
                        backgroundColor: '#5FA883',
                        borderColor: '#333333',        // 테두리 색 (진한 회색)
                        borderWidth: 1,
                        borderSkipped: 'bottom'   // 아래쪽만 스킵 → 위·좌·우만 남음
                    },
                    {
                        label: '최고(Max)',
                        data: maxPrices,
                        backgroundColor: '#8CD1A8CC'
                    },
                    {
                        label: '최저(Min)',
                        data: minPrices,
                        backgroundColor: '#B3E8CB'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '장르별 도서가격',
                        font: { size: 17, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => Math.round(ctx.raw).toLocaleString() + ' 원'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (val) => val.toLocaleString() + ' 원'
                        },
                        grid: {  
                            color: "rgba(0, 0, 0, 0.1)",   // 격자선 색상
                            borderDash: [5, 5],            // 점선 (5px 선, 5px 공백)
                            lineWidth: 0.5                 // 선 두께
                        }
                    }
                }
            }
        });
    });



    // --------------------------
    // --- 추천책 3개 ----
    // --------------------------
    function loadRecommendedBooks() {     // 함수로 감싸기
        fetch("{% url 'genre-recommend-top3' %}")
            .then(res => res.json())
            .then(data => {
                console.log("추천 top3:", data);
                const container = document.getElementById('recommend-thumbnails');
                container.innerHTML = ""; // 기존 추천 제거 후 새로 표시
                data.forEach(book => {
                    const html = `
                        <div class="book-card">
                            <a href="${book.book_detail}" target="_blank" class="book-link">
                                <img src="${book.book_img}" class="book-img">
                                <p class="book-title">${book.title}</p>
                            </a>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            });
    }

    // 페이지 처음 로드 시 실행
    document.addEventListener("DOMContentLoaded", loadRecommendedBooks);

    // “추천 다시 보기” 버튼 클릭 시에도 실행
    document.getElementById("refresh-recommend-btn").addEventListener("click", loadRecommendedBooks);




    // ---------------------------
    // --- 장르별 상관관계 히트맵 ---
    // ---------------------------
    fetch("{% url 'genre-heatmap' %}")
    .then(res => res.json())
    .then(data => {
        const genres = Object.keys(data); // ['소설','경제',...]
        const metrics = ['Price','Score','Reviews','GMV']; // x축 4개

        // z값: 각 장르별 [price, score, reviews, gmv]
        const z = genres.map(g => [
            data[g].price,
            data[g].score,
            data[g].num_of_review,
            data[g].gmv
        ]);

        const zmin = Math.min(...z.flat());
        const zmax = Math.max(...z.flat());

        const trace = {
            z: z,
            x: genres,
            y: genres,
            type: 'heatmap',
            colorscale: 'Cividis',
            zmin: zmin,
            zmax: zmax,
            //colorbar: { title: 'Value' },
            colorbar: { title: 'Correlation' },
            hoverongaps: false,
            //hovertemplate: '%{y}<br>%{x}: %{z}<extra></extra>'
            hovertemplate: '%{y} ↔ %{x}: %{z}<extra></extra>',
            colorbar: {
                title: 'Correlation',
                thickness: 15,   // colorbar 두께
                len: 0.8,        // colorbar 길이 (0~1)
                y: 0.5           // 세로 중앙 정렬
            }
        };

        const layout = {
            autosize: true,
            title: {
            text: '장르별 지표 히트맵',
            font: {
                size: 17,        
                color: '#444444',
                family: 'sans-serif',
                weight: 'bold'
                }
            },
            margin: { t: 50, l: 80, r:40, b:80 },
            yaxis: { automargin: true},
            xaxis: { tickangle: -45},
    
            plot_bgcolor: 'rgba(0,0,0,0)',   // 그래프 내부 배경 투명
            paper_bgcolor: 'rgba(0,0,0,0)'   // 전체 배경 투명
        };

        Plotly.newPlot('genre-heatmap', [trace], layout, {responsive: true});
    });


    </script>

    </body>
</html>
