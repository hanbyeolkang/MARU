{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MARU Book analysis</title>
    <link rel="stylesheet" type="text/css" href="{% static 'maru/css/common.css' %}">
    <!-- Chart.js & DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Plotly.js CDN -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id="whole">
    {% include 'maru/header.html' %}
    <div class="content">
        <!-- Section 1: Donut chart for regional distribution -->
        <section class="statistics">
            <span style="color: rgb(112, 112, 112); font-size: 14px;">Kyobo Bookstore Data Across 13 Genres</span>
            <canvas id="locationChart" style="width: 100%; max-width: 600px; max-height: 400px; margin: 20px auto;"></canvas>
        </section>
        <!-- Section 2: Bar chart for GMV by region -->
        <section class="statistics">
            <span style="color: rgb(112, 112, 112); font-size: 14px;">Top Products by Region</span>
            <canvas id="locationGMVChart" style="width: 100%; max-height: 400px; margin: 20px auto;"></canvas>
        </section>
        <!-- Section 3: Top 3 books by region (thumbnails) -->
        <section class="statistics">
            <span style="color: rgb(131, 131, 131); font-size: 14px;">Top 3 Books by Region. Click covers for details.</span>
            <div id="location-thumbnails" class="thumbnail-container"></div>
        </section>
        <!-- Section 4: Grouped bar chart for book prices by region -->
        <section class="statistics">
            <span style="color: rgb(112, 112, 112); font-size: 14px;">Book Prices by Region (KRW)</span>
            <canvas id="locationPriceChart" style="width: 100%; max-height: 400px; margin: 20px auto;"></canvas>
        </section>
        <!-- Section 5: Recommended books (Pick 3) -->
        <section class="statistics recommend-section">
            <span style="color: rgb(31, 146, 77); font-size: 14px;">↓ Click to discover more picks!</span>
            <p id="refresh-message" style="font-size:17px; color:rgb(112, 112, 112); font-weight:bold; margin-top:5px; text-align:center;">
                MARU의 추천책 pick!
            </p>
            <div style="text-align:center; margin-top:8px;">
                <button id="refresh-recommend-btn">Pick 3</button>
            </div>
            <div id="recommend-thumbnails" class="recommend-container"></div>
        </section>
        <!-- Section 6: Correlation heatmap for regions -->
        <section class="statistics">
            <span style="color: rgb(112, 112, 112); font-size: 14px;">Location Correlation Heatmap (Price, Score, Reviews, GMV)</span>
            <div id="location-heatmap" style="width: 100%; height: 500px; margin: 0 auto;"></div>
        </section>
    </div>
</div>
<!-- Scripts to fetch data and render charts -->
<script>
// 1. Donut chart: Distribution of books across regions
fetch("{% url 'location-data' %}")
    .then(res => res.json())
    .then(data => {
        data.sort((a, b) => b.count - a.count);
        const labels = data.map(d => d.location);
        const counts = data.map(d => d.count);
        const total = counts.reduce((a, b) => a + b, 0);
        const percents = counts.map(c => ((c / total) * 100).toFixed(1));
        new Chart(document.getElementById('locationChart'), {
            type: 'doughnut',
            data: {
                labels: labels.map((loc, i) => `${loc} (${percents[i]}%)`),
                datasets: [{
                    data: counts,
                    backgroundColor: [
                        '#EB99A1','#EABF91','#F0E38D','#8CD1A8','#8CC7F0',
                        '#C1A8F0','#EB8CCB','#8DD8CC','#F0C89A','#9CC3F0'
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '지역별 도서 분포',
                        font: { size: 17, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.label}: ${ctx.raw}권 (${percents[ctx.dataIndex]}%)`
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold' },
                        formatter: (value) => value  // show raw counts on slices
                    }
                }
            }
        });
    });

// 2. Bar chart: GMV by region with custom tooltip
fetch("{% url 'location-gmv-data' %}")
    .then(res => res.json())
    .then(data => {
        data.sort((a, b) => b.gmv - a.gmv);
        console.log("location-gmv-data sorted:", data);
        // Prepare extra data for tooltips (avg price, reviews, score per region)
        const extraData = {};
        data.forEach(d => {
            extraData[d.location] = {
                price: d.price,
                num_of_review: d.num_of_review,
                score: d.score
            };
        });
        const labels = data.map(d => d.location);
        const gmvs = data.map(d => d.gmv);
        new Chart(document.getElementById('locationGMVChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '지역별 GMV (price * num_of_review * score)',
                    data: gmvs,
                    backgroundColor: '#8CC7F0',
                    borderColor: '#333333',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '지역별 핵심상품',
                        font: { size: 17, weight: 'bold' }
                    },
                    tooltip: {
                        enabled: true,
                        callbacks: {
                            label: function(ctx) {
                                const loc = ctx.label;
                                const gmvStr = Math.round(ctx.raw).toLocaleString();
                                const info = extraData[loc] || {};
                                const avgPrice = info.price !== undefined ? Math.round(info.price).toLocaleString() : '-';
                                const avgRev = info.num_of_review !== undefined ? info.num_of_review.toLocaleString() : '-';
                                const avgScore = info.score !== undefined ? info.score.toFixed(1) : '-';
                                return [
                                    `GMV: ${gmvStr}`,
                                    `평균 가격: ${avgPrice}원`,
                                    `평균 리뷰 수: ${avgRev}개`,
                                    `평균 평점: ${avgScore}점`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    });

// 3. Top 3 books by region (thumbnails with links)
fetch("{% url 'location-top3-json' %}")
    .then(res => res.json())
    .then(data => {
        console.log("지역별 top3 JSON:", data);  // check structure in console
        const container = document.getElementById('location-thumbnails');
        container.innerHTML = "";
        Object.keys(data).forEach(loc => {
            const books = data[loc];  // top3 books array for this location
            const locBlock = document.createElement('div');
            locBlock.classList.add('genre-block');  /* reuse genre-block styling */
            let html = `<h3 class="genre-title">${loc}</h3><div class="genre-books">`;
            books.forEach(book => {
                html += `
                    <div class="book-card">
                        <a href="${book.book_detail}" target="_blank" class="book-link">
                            <img src="${book.book_img}" alt="${book.title}" class="book-thumbnail">
                            <div class="book-info">
                                <p class="book-title">${book.title}</p>
                                <p class="book-author">${book.author}</p>
                            </div>
                        </a>
                    </div>
                `;
            });
            html += `</div>`;
            locBlock.innerHTML = html;
            container.appendChild(locBlock);
        });
    });

// 4. Grouped bar chart: Avg/Max/Min book prices by region
fetch("{% url 'location-price-data' %}")
    .then(res => res.json())
    .then(data => {
        data.sort((a, b) => b.mean - a.mean);
        const labels = data.map(d => d.location);
        const avgPrices = data.map(d => d.mean);
        const maxPrices = data.map(d => d.max);
        const minPrices = data.map(d => d.min);
        new Chart(document.getElementById('locationPriceChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '평균(Avg)',
                        data: avgPrices,
                        backgroundColor: '#5FA883',
                        borderColor: '#333333', 
                        borderWidth: 1,
                        borderSkipped: 'bottom'
                    },
                    {
                        label: '최고(Max)',
                        data: maxPrices,
                        backgroundColor: '#8CD1A8CC'
                    },
                    {
                        label: '최저(Min)',
                        data: minPrices,
                        backgroundColor: '#B3E8CB'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '지역별 도서가격',
                        font: { size: 17, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => Math.round(ctx.raw).toLocaleString() + ' 원'
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    });

// 5. Recommended picks (three random highly-rated books) - load on page and on button click
function loadRecommendedBooks() {
    fetch("{% url 'location-recommend-top3' %}")
        .then(res => res.json())
        .then(data => {
            console.log("추천 top3:", data);
            const container = document.getElementById('recommend-thumbnails');
            container.innerHTML = "";  // clear previous picks
            data.forEach(book => {
                const html = `
                    <div class="book-card">
                        <a href="${book.book_detail}" target="_blank" class="book-link">
                            <img src="${book.book_img}" class="book-img" alt="${book.title}">
                            <p class="book-title">${book.title}</p>
                        </a>
                    </div>
                `;
                container.innerHTML += html;
            });
        });
}
// Load recommendations on page load and button click
document.addEventListener("DOMContentLoaded", loadRecommendedBooks);
document.getElementById("refresh-recommend-btn").addEventListener("click", loadRecommendedBooks);

// 6. Correlation heatmap: Compute correlations between regions based on their average metrics
fetch("{% url 'location-heatmap' %}")
    .then(res => res.json())
    .then(data => {
        const locations = Object.keys(data);
        const metrics = ['price', 'score', 'num_of_review', 'gmv'];
        // Build correlation matrix z (locations x locations)
        const z = [];
        let zmin = 1, zmax = 1;
        for (let i = 0; i < locations.length; i++) {
            z[i] = [];
            for (let j = 0; j < locations.length; j++) {
                if (i === j) {
                    z[i][j] = 1;  // correlation with itself
                } else {
                    const loc1 = locations[i], loc2 = locations[j];
                    // arrays of values for each metric
                    const arr1 = metrics.map(m => data[loc1][m]);
                    const arr2 = metrics.map(m => data[loc2][m]);
                    // compute Pearson correlation
                    const mean1 = arr1.reduce((a, b) => a + b, 0) / arr1.length;
                    const mean2 = arr2.reduce((a, b) => a + b, 0) / arr2.length;
                    let num = 0, den1 = 0, den2 = 0;
                    for (let k = 0; k < metrics.length; k++) {
                        const diff1 = arr1[k] - mean1;
                        const diff2 = arr2[k] - mean2;
                        num += diff1 * diff2;
                        den1 += diff1 * diff1;
                        den2 += diff2 * diff2;
                    }
                    const corr = (den1 && den2) ? (num / Math.sqrt(den1 * den2)) : 0;
                    z[i][j] = Math.round(corr * 100) / 100;  // round to 2 decimals
                    if (z[i][j] < zmin) zmin = z[i][j];
                    if (z[i][j] > zmax) zmax = z[i][j];
                }
            }
        }
        const trace = {
            z: z,
            x: locations,
            y: locations,
            type: 'heatmap',
            colorscale: 'Cividis',
            zmin: zmin,
            zmax: zmax,
            colorbar: { title: 'Correlation' },
            hoverongap: false
        };
        const layout = {
            xaxis: { automargin: true },
            yaxis: { automargin: true },
            margin: { t: 20, b: 20 }
        };
        Plotly.newPlot('location-heatmap', [trace], layout, {responsive: true});
    });
</script>
</body>
</html>
